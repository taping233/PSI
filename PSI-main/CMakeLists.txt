cmake_minimum_required(VERSION 3.15)
project(PSI C)

# ==============================
# ğŸ”§ åŸºç¡€é…ç½®
# ==============================
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})

# ==============================
# ğŸ“¦ æŸ¥æ‰¾ä¾èµ–åº“
# ==============================
if(APPLE)
    message(STATUS "ğŸ macOS ç¯å¢ƒæ£€æµ‹åˆ°ï¼Œä½¿ç”¨ Homebrew è·¯å¾„é…ç½®")

    # Homebrew è·¯å¾„
    set(HOMEBREW_PREFIX "/opt/homebrew")

    # OpenMP (macOS ä¸Š Clang é»˜è®¤ä¸æ”¯æŒï¼Œéœ€è¦ libomp)
    set(OpenMP_C_FLAGS "-Xpreprocessor -fopenmp")
    set(OpenMP_C_LIB_NAMES "omp")
    set(OpenMP_omp_LIBRARY "${HOMEBREW_PREFIX}/opt/libomp/lib/libomp.dylib")
    include_directories("${HOMEBREW_PREFIX}/opt/libomp/include")
    link_directories("${HOMEBREW_PREFIX}/opt/libomp/lib")

    # GMP
    include_directories("${HOMEBREW_PREFIX}/opt/gmp/include")
    link_directories("${HOMEBREW_PREFIX}/opt/gmp/lib")

    # OpenSSL
    include_directories("${HOMEBREW_PREFIX}/opt/openssl/include")
    link_directories("${HOMEBREW_PREFIX}/opt/openssl/lib")
else()
    message(STATUS "ğŸ§ Linux ç¯å¢ƒæ£€æµ‹åˆ°ï¼Œä½¿ç”¨ç³»ç»Ÿè·¯å¾„é…ç½®")
endif()

# ==============================
# ğŸ§µ OpenMP é…ç½®
# ==============================
find_package(OpenMP REQUIRED)
if(OpenMP_C_FOUND)
    message(STATUS "âœ… OpenMP æ£€æµ‹æˆåŠŸ")
else()
    message(FATAL_ERROR "âŒ æœªæ‰¾åˆ° OpenMPï¼Œè¯·ç¡®è®¤ç¼–è¯‘å™¨æ”¯æŒ -fopenmp")
endif()

# ==============================
# ğŸ“ æºæ–‡ä»¶
# ==============================
set(SOURCES
    main.c
    PSI.c
    PSI_Cloud.c
    client.c
    Verify.c
    Beaver_Cloud.c
    beaver.c
    bucket.c
    crt_gmp.c
    crypt.c
    dataset.c
    fft_poly.c
    hash.c
    modsystem.c
)

set(HEADERS
    PSI.h
    PSI_Cloud.h
    client.h
    Verify.h
    Beaver_Cloud.h
    beaver.h
    bucket.h
    crt_gmp.h
    crypt.h
    dataset.h
    fft_poly.h
    hash.h
    modsystem.h
)

# ==============================
# ğŸ¯ å¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡
# ==============================
add_executable(psi_program ${SOURCES} ${HEADERS})
add_executable(psi_program_debug ${SOURCES} ${HEADERS})

# ==============================
# âš™ï¸ ç¼–è¯‘é€‰é¡¹
# ==============================
target_compile_options(psi_program PRIVATE
    -Wall
    -O2
    -g
    -fno-omit-frame-pointer
    -fno-optimize-sibling-calls
)

target_compile_options(psi_program_debug PRIVATE
    -Wall
    -O0
    -g
    -fsanitize=address
    -fno-omit-frame-pointer
    -fno-optimize-sibling-calls
)

# ==============================
# ğŸ”— é“¾æ¥åº“
# ==============================
target_link_libraries(psi_program PRIVATE
    gmp
    crypto
    ssl
    m
    pthread
    OpenMP::OpenMP_C
)

target_link_libraries(psi_program_debug PRIVATE
    gmp
    crypto
    ssl
    m
    pthread
    OpenMP::OpenMP_C
)

target_link_options(psi_program_debug PRIVATE
    -fsanitize=address
)

# ==============================
# ğŸ“„ å®‰è£…é…ç½®
# ==============================
install(TARGETS psi_program
    RUNTIME DESTINATION bin
)

# ==============================
# ğŸ’¬ æç¤ºä¿¡æ¯
# ==============================
message(STATUS "")
message(STATUS "ğŸ”§ PSI é¡¹ç›®é…ç½®å®Œæˆ")
message(STATUS "ğŸ“¦ è¾“å‡ºç›®å½•: ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}")
message(STATUS "ğŸ“ compile_commands.json å°†ç”Ÿæˆåœ¨æ„å»ºç›®å½•")
message(STATUS "")
message(STATUS "ğŸ’¡ æ„å»ºæ­¥éª¤:")
message(STATUS "   mkdir -p build && cd build")
message(STATUS "   cmake ..")
message(STATUS "   make -j$(nproc)")
message(STATUS "")
message(STATUS "ğŸ’¡ è¿è¡Œå‰å¯è®¾ç½® AddressSanitizer:")
message(STATUS "   export ASAN_OPTIONS=fast_unwind_on_malloc=0:malloc_context_size=50")